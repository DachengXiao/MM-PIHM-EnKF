#include "pihm.h"

void ApplyForcing (forcing_ts_struct *forcing, int t)
{
    int         i, j;
    double      meteo[NUM_METEO_TS];

    /* Boundary conditions */
    for (i = 0; i < forcing->nts[BC_TS]; i++)
        IntrplForcing (forcing->ts[BC_TS][i], t, 1, &forcing->bc[i]);

    /* Meteorological forcing */
    for (i = 0; i < forcing->nts[METEO_TS]; i++)
    {
        IntrplForcing (forcing->ts[METEO_TS][i], t, NUM_METEO_TS, meteo);

        for (j = 0; j < NUM_METEO_TS; j++)
            forcing->meteo[j][i] = meteo[j];
    }

    /* LAI forcing */
    for (i = 0; i < forcing->nts[LAI_TS]; i++)
        IntrplForcing (forcing->ts[LAI_TS][i], t, 1, &forcing->lai[i]);

    /* River boundary condition */
    for (i = 0; i < forcing->nts[RIV_TS]; i++)
        IntrplForcing (forcing->ts[RIV_TS][i], t, 1, &forcing->riverbc[i]);
}

void IntrplForcing (ts_struct ts, int t, int nvrbl, double *vrbl)
{
    int             j;
    int             first, middle, last;

    if (t <= ts.ftime[0])
    {
        for (j = 0; j < nvrbl; j++)
            vrbl[j] = ts.data[0][j];
    }
    else if (t >= ts.ftime[ts.length - 1])
    {
        for (j = 0; j < nvrbl; j++)
            vrbl[j] = ts.data[ts.length - 1][j];
    }
    else
    {
        first = 1;
        last = ts.length - 1;

        while (first <= last)
        {
            middle = (first + last) / 2;
            if (t >= ts.ftime[middle - 1] && t <= ts.ftime[middle])
            {
                for (j = 0; j < nvrbl; j++)
                    vrbl[j] = ((double) (ts.ftime[middle] - t) * ts.data[middle - 1][j] + (double) (t - ts.ftime[middle - 1]) * ts.data[middle][j]) / (double) (ts.ftime[middle] - ts.ftime[middle - 1]);
                break;
            }
            else if (ts.ftime[middle] > t)
                last = middle - 1;
            else
                first = middle + 1;
        }
    }
}
        
double MonthlyLAI (int t, int lc_type)
{
    time_t         rawtime;
    struct tm      *timestamp;

    double        lai_tbl[20][12] = {
                    {8.760, 9.160, 9.827, 10.09, 10.36, 10.76, 10.49, 10.23, 10.09, 9.827, 9.160, 8.760},
                    {5.117, 5.117, 5.117, 5.117, 5.117, 5.117, 5.117, 5.117, 5.117, 5.117, 5.117, 5.117},
                    {8.760, 9.160, 9.827, 10.09, 10.36, 10.76, 10.49, 10.23, 10.09, 9.827, 9.160, 8.760},
                    {0.520, 0.520, 0.867, 2.107, 4.507, 6.773, 7.173, 6.507, 5.040, 2.173, 0.867, 0.520},
                    {4.640, 4.840, 5.347, 6.100, 7.434, 8.767, 8.833, 8.367, 7.567, 6.000, 5.014, 4.640},
                    {0.581, 0.629, 0.629, 0.629, 0.919, 1.769, 2.551, 2.554, 1.729, 0.970, 0.726, 0.629},
                    {0.400, 0.404, 0.314, 0.223, 0.250, 0.330, 0.432, 0.800, 1.167, 0.798, 0.504, 0.404},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {0.782, 0.893, 1.004, 1.116, 1.782, 3.671, 4.782, 4.227, 2.004, 1.227, 1.004, 0.893},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {0.782, 0.893, 1.004, 1.116, 1.782, 3.671, 4.782, 4.227, 2.004, 1.227, 1.004, 0.893},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001},
                    {0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0}};

    rawtime = t;
    timestamp = gmtime (&rawtime);

    return (lai_tbl[lc_type - 1][timestamp->tm_mon]);
}

double MonthlyRL (int t, int lc_type)
{
    time_t          rawtime;
    struct tm      *timestamp;

    double        rl_tbl[20][12] = {
                    {1.112, 1.103, 1.088, 1.082, 1.076, 1.068, 1.073, 1.079, 1.082, 1.088, 1.103, 1.112},
                    {2.653, 2.653, 2.653, 2.653, 2.653, 2.653, 2.653, 2.653, 2.653, 2.653, 2.653, 2.653},
                    {1.112, 1.103, 1.088, 1.082, 1.076, 1.068, 1.073, 1.079, 1.082, 1.088, 1.103, 1.112},
                    {0.520, 0.520, 0.666, 0.910, 1.031, 1.044, 1.042, 1.037, 1.036, 0.917, 0.666, 0.520},
                    {0.816, 0.812, 0.877, 0.996, 1.054, 1.056, 1.058, 1.058, 1.059, 1.003, 0.885, 0.816},
                    {0.056, 0.056, 0.056, 0.054, 0.054, 0.054, 0.054, 0.057, 0.059, 0.058, 0.057, 0.056},
                    {0.037, 0.037, 0.035, 0.033, 0.033, 0.033, 0.033, 0.039, 0.041, 0.040, 0.038, 0.037},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {0.078, 0.078, 0.078, 0.078, 0.078, 0.077, 0.076, 0.077, 0.078, 0.078, 0.078, 0.078},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {0.078, 0.078, 0.078, 0.078, 0.078, 0.077, 0.076, 0.077, 0.078, 0.078, 0.078, 0.078},
                    {0.195, 0.194, 0.208, 0.233, 0.246, 0.246, 0.245, 0.246, 0.247, 0.235, 0.210, 0.195},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {0.078, 0.078, 0.078, 0.078, 0.078, 0.077, 0.076, 0.077, 0.078, 0.078, 0.078, 0.078},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0},
                    {999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0, 999.0}};

    rawtime = t;
    timestamp = gmtime (&rawtime);

    return (rl_tbl[lc_type - 1][timestamp->tm_mon]);
}

double MonthlyMF (int t)
{
    time_t         rawtime;
    struct tm      *timestamp;

    double        mf_tbl[12] = { 0.001308019, 0.001633298, 0.002131198, 0.002632776, 0.003031171, 0.003197325, 0.003095839, 0.002745240, 0.002260213, 0.001759481, 0.001373646, 0.001202083};

    rawtime = t;
    timestamp = gmtime (&rawtime);

    return (mf_tbl[timestamp->tm_mon]);
}

